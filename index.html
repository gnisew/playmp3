<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>支持本地文件的MP3聲波播放器插件示例</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #2c3e50;
        }
        #waveform-container {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 20px;
        }
        .instructions {
            background-color: #f8f8f8;
            border-left: 4px solid #4CAF50;
            margin: 20px 0;
            padding: 10px 20px;
        }
        #initButton, #fileInput {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            font-size: 16px;
            color: white;
            background-color: #4CAF50;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #initButton:hover, #fileInput:hover {
            background-color: #45a049;
        }
        #fileInput {
            background-color: #3498db;
        }
        #fileInput:hover {
            background-color: #2980b9;
        }
    </style>
</head>
<body>
    <h1>支持本地文件的MP3聲波播放器插件示例</h1>
    
    <div class="instructions">
        <p>操作說明：</p>
        <ul>
            <li>選擇本地MP3文件或使用預設URL</li>
            <li>點擊「初始化播放器」按鈕來啟動播放器</li>
            <li>單擊波形：播放/暫停</li>
            <li>雙擊波形：從頭開始播放</li>
        </ul>
    </div>

    <input type="file" id="fileInput" accept="audio/mp3">
    <button id="initButton">初始化播放器</button>
    <div id="waveform-container"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/6.6.3/wavesurfer.min.js"></script>
    <script>
    // 改進的MP3聲波播放器插件
    (function(window) {
        let wavesurfer;

        function createMP3WaveformPlayer(elementId, audioSource) {
            const container = document.getElementById(elementId);
            if (!container) {
                console.error('Container element not found');
                return;
            }

            // 創建波形圖容器
            const waveformDiv = document.createElement('div');
            waveformDiv.style.width = '100%';
            waveformDiv.style.height = '128px';
            waveformDiv.style.backgroundColor = '#f0f0f0';
            waveformDiv.style.borderRadius = '4px';
            waveformDiv.style.overflow = 'hidden';
            container.appendChild(waveformDiv);

            // 創建狀態顯示元素
            const statusDiv = document.createElement('div');
            statusDiv.style.marginTop = '10px';
            statusDiv.style.textAlign = 'center';
            statusDiv.style.color = '#666';
            statusDiv.style.fontSize = '14px';
            container.appendChild(statusDiv);

            // 初始化WaveSurfer
            wavesurfer = WaveSurfer.create({
                container: waveformDiv,
                waveColor: '#4CAF50',
                progressColor: '#45a049',
                cursorColor: '#333',
                barWidth: 2,
                barRadius: 3,
                cursorWidth: 1,
                height: 128,
                barGap: 2
            });

            // 加載音頻
            if (audioSource instanceof File) {
                wavesurfer.loadBlob(audioSource);
            } else {
                wavesurfer.load(audioSource);
            }

            // 單擊事件：播放/暫停
            waveformDiv.addEventListener('click', function(e) {
                wavesurfer.playPause();
            });

            // 雙擊事件：從頭播放
            let lastClickTime = 0;
            waveformDiv.addEventListener('click', function(e) {
                const currentTime = new Date().getTime();
                const timeDiff = currentTime - lastClickTime;
                if (timeDiff < 300) {  // 300毫秒內的雙擊
                    wavesurfer.stop();
                    wavesurfer.play();
                }
                lastClickTime = currentTime;
            });

            // 音頻加載完成事件
            wavesurfer.on('ready', function() {
                statusDiv.textContent = '音頻已加載，點擊波形播放/暫停，雙擊從頭播放';
            });

            // 錯誤處理
            wavesurfer.on('error', function(e) {
                console.error('WaveSurfer error:', e);
                statusDiv.textContent = '加載音頻時出錯：' + e;
            });

            // 加載進度
            wavesurfer.on('loading', function(percent) {
                statusDiv.textContent = '加載進度：' + percent + '%';
            });

            return wavesurfer;
        }

        // 將函數暴露到全局作用域
        window.initMP3WaveformPlayer = function(elementId, defaultMp3Url) {
            const initButton = document.getElementById('initButton');
            const fileInput = document.getElementById('fileInput');
            
            initButton.addEventListener('click', function() {
                let audioSource = defaultMp3Url;
                if (fileInput.files.length > 0) {
                    audioSource = fileInput.files[0];
                }
                createMP3WaveformPlayer(elementId, audioSource);
                initButton.style.display = 'none';  // 隱藏初始化按鈕
                fileInput.style.display = 'none';   // 隱藏文件輸入
            });
        };
    })(window);

    // 使用插件
    document.addEventListener('DOMContentLoaded', function() {
        window.initMP3WaveformPlayer('waveform-container', 'k010.mp3');
    });
    </script>
</body>
</html>